================================================================================
STATUS WORKFLOW CONTROL: THREE-LAYER ARCHITECTURE
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ LAYER 1: PLANNING ARTIFACTS (Storage & Data Model)                         │
│ @devtools/files/opencode/skills/projectmanagement/info-planning-artifacts  │
│                                                                              │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ BasicMemory Storage (Project-Scoped)                                │   │
│ │                                                                      │   │
│ │  1-prds/            → PRD (strategic direction)                     │   │
│ │  2-epics/           → Epic (major work)                            │   │
│ │  ├─ spec            → Spec (detailed requirements)                 │   │
│ │  3-research/        → Research (investigation)                     │   │
│ │  4-stories/         → Story (user scenarios)                       │   │
│ │  5-tasks/           → Task (implementation work)                   │   │
│ │  6-decisions/       → Decision (choices made)                      │   │
│ │  9-retrospectives/  → Retrospective (closure)                      │   │
│ │                                                                      │   │
│ │ Each artifact has EXPLICIT STATUS in frontmatter:                  │   │
│ │  - Epic:        { Active | Completed | On Hold | Cancelled }      │   │
│ │  - Story:       { To Do | In Progress | In Review | Done | Cancel │   │
│ │  - Task:        { To Do | In Progress | In Review | Done | Blocked│   │
│ │  - Research:    { In Progress | Complete | Inconclusive | Supersed│   │
│ │  - Decision:    { Pending | Decided | Unresolved | Superseded }   │   │
│ │  - Retrospect:  { In Progress | Complete }                        │   │
│ │                                                                      │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│ Johnny Decimal: 2.1.1-epic-name.md (category.sequence.increment-type-name) │
│ Frontmatter: status | storyPoints | priority | assignee | dueDate | links  │
│ Links: Obsidian wiki-style [[ ]] + frontmatter relationships               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↑
                                    │
                         Uses templates from:
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│ LAYER 2: COMMAND LAYER (Workflow Orchestration)                            │
│ @devtools/files/opencode/command/project/                                  │
│                                                                              │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ PLANNING COMMANDS (Create Artifacts)                               │   │
│ │                                                                     │   │
│ │  /project:plan:prd                                                │   │
│ │  /project:plan:epic                                               │   │
│ │  /project:plan:feature      ← Creates Epic + Spec pair           │   │
│ │  /project:plan:stories      ← Breaks Epic into Stories           │   │
│ │  /project:plan:tasks        ← Decomposes Story into Tasks        │   │
│ │  /project:plan:research                                           │   │
│ │  /project:plan:decision                                           │   │
│ │                                                                     │   │
│ │  Command files: plan.*.md   (Step-by-step workflows)              │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ EXECUTION COMMANDS (Transition Status)                             │   │
│ │                                                                     │   │
│ │  /project:do:task           ← Starts task (To Do → In Progress)   │   │
│ │   │                           - Creates git worktree              │   │
│ │   │                           - Runs tests baseline               │   │
│ │   │                           - Updates artifact status           │   │
│ │   ├─ git commit                                                    │   │
│ │   └─ /project:do:commit     ← Submits (In Progress → In Review)   │   │
│ │       │                        - Creates semantic commit          │   │
│ │       │                        - Creates PR                       │   │
│ │       │                        - Updates artifact status          │   │
│ │       └─ Reviewer merges PR                                       │   │
│ │           └─ Update status (In Review → Done)  [MISSING: webhook] │   │
│ │                                                                     │   │
│ │  Command files: do.*.md     (Step-by-step workflows)              │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ MONITORING COMMANDS (Query State)                                  │   │
│ │                                                                     │   │
│ │  /project:status            ← Show current context                │   │
│ │   │                           - Aggregates all artifacts          │   │
│ │   │                           - Shows hierarchical tree           │   │
│ │   │                           - Calculates completion %           │   │
│ │   │                           - Suggests next actions             │   │
│ │   ├─ /project:view          ← View specific artifact              │   │
│ │   └─ /project:query         ← Search/filter                       │   │
│ │                                                                     │   │
│ │  Command files: status.md, view.md, query.md                      │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ COMPLETION COMMANDS                                                │   │
│ │                                                                     │   │
│ │  /project:close             ← Archive completed work              │   │
│ │   │                           - Creates Retrospective              │   │
│ │   │                           - Links Unresolved Decisions         │   │
│ │   │                           - Suggests follow-up work            │   │
│ │   └─ /project:bug           ← Report/fix bugs                     │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↑
                                    │
                         Delegates to skills:
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│ LAYER 3: SKILLS LAYER (Capabilities & Metadata)                            │
│ @devtools/files/opencode/skills/projectmanagement/                         │
│                                                                              │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ projectmanagement                                                  │   │
│ │  └─ Root skill (entry point)                                      │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ projectmanagement_storage_basicmemory                              │   │
│ │  ├─ Create artifacts with structure                               │   │
│ │  ├─ Update status fields in frontmatter                           │   │
│ │  ├─ Query by status/epic/project                                  │   │
│ │  ├─ Generate ProjectId (from repo name)                           │   │
│ │  └─ Handle concurrent access                                      │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ projectmanagement_info_planning_artifacts                         │   │
│ │  ├─ Artifact type definitions (8 types)                           │   │
│ │  ├─ Status flow diagrams [REFERENCED BUT MISSING]                 │   │
│ │  ├─ Schema definitions [REFERENCED BUT MISSING]                   │   │
│ │  ├─ Johnny Decimal structure rules                                │   │
│ │  └─ Templates for each artifact type:                             │   │
│ │      ├─ epic_template.md                                          │   │
│ │      ├─ spec_template.md                                          │   │
│ │      ├─ story_template.md                                         │   │
│ │      ├─ task_template.md                                          │   │
│ │      ├─ research_template.md                                      │   │
│ │      ├─ decision_template.md                                      │   │
│ │      ├─ retrospective_template.md                                 │   │
│ │      └─ prd_template.md [REFERENCED BUT MISSING]                  │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================
STATUS LIFECYCLE: TASK EXAMPLE
================================================================================

     ┌────────────────────────────────────────────────────────────────┐
     │ CREATION PHASE: /project:plan:tasks "#5"                      │
     ├────────────────────────────────────────────────────────────────┤
     │ Artifact created:                                              │
     │  5.1.1-task-database-schema.md                                 │
     │  status: To Do  ← Default from task_template.md                │
     └────────────────────────────────────────────────────────────────┘
                            ↓
     ┌────────────────────────────────────────────────────────────────┐
     │ EXECUTION PHASE: /project:do:task #123                        │
     ├────────────────────────────────────────────────────────────────┤
     │ Status updated:                                                │
     │  To Do → In Progress                                           │
     │ Worktree created: 123-database-schema                          │
     │ Tests run: baseline                                            │
     │ Ready for development                                          │
     └────────────────────────────────────────────────────────────────┘
                            ↓
     ┌────────────────────────────────────────────────────────────────┐
     │ DEVELOPMENT PHASE                                              │
     ├────────────────────────────────────────────────────────────────┤
     │ User develops in isolated worktree                             │
     │ Status remains: In Progress                                    │
     │ Work log entries track progress                                │
     │ Adds commits to feature branch                                 │
     └────────────────────────────────────────────────────────────────┘
                            ↓
     ┌────────────────────────────────────────────────────────────────┐
     │ SUBMISSION PHASE: /project:do:commit                          │
     ├────────────────────────────────────────────────────────────────┤
     │ Status updated:                                                │
     │  In Progress → In Review                                       │
     │ Semantic commit created                                        │
     │ PR created on GitHub                                           │
     │ Work log entry added: "Ready for review"                       │
     └────────────────────────────────────────────────────────────────┘
                            ↓
     ┌────────────────────────────────────────────────────────────────┐
     │ REVIEW PHASE                                                   │
     ├────────────────────────────────────────────────────────────────┤
     │ Status remains: In Review                                      │
     │ Reviewer checks code/tests/documentation                       │
     │ Can request changes → back to development                      │
     │ Or approve → ready to merge                                    │
     └────────────────────────────────────────────────────────────────┘
                            ↓
     ┌────────────────────────────────────────────────────────────────┐
     │ COMPLETION PHASE: PR Merged                                    │
     ├────────────────────────────────────────────────────────────────┤
     │ Status updated:                                                │
     │  In Review → Done                                              │
     │ Parent Story recalculates status (aggregated)                  │
     │ Parent Epic recalculates status (aggregated)                   │
     │ Worktree cleaned up                                            │
     │ Work log finalized                                             │
     │ NOTE: Currently manual (webhook missing)                       │
     └────────────────────────────────────────────────────────────────┘

================================================================================
KEY DESIGN PRINCIPLES
================================================================================

1. STATUS AS SOURCE OF TRUTH
   - Explicit frontmatter field (not derived)
   - Always queryable and trackable
   - Single authoritative value

2. HIERARCHY-DRIVEN AGGREGATION
   Task status → Story status → Epic status
   └─ Automatic calculation (not manual)

3. PHASE-GATED TRANSITIONS
   Cannot skip steps (e.g., To Do → In Review blocked)
   └─ Enforced by commands (not by tools)

4. RELATIONSHIP LINKING
   Tasks link to Stories and Epics via frontmatter
   └─ Enables blocking analysis and critical path

5. COMMAND-DRIVEN WORKFLOW
   No implicit state changes
   └─ All transitions via explicit commands

================================================================================
CRITICAL GAPS
================================================================================

MISSING FILES:
  ❌ references/status-flow.md       [Referenced but NOT found]
  ❌ references/schema.md            [Referenced but NOT found]
  ❌ prd_template.md                 [Referenced but NOT found]

MISSING AUTOMATION:
  ❌ GitHub webhook for PR merge → auto-update status
  ❌ Cascade status updates (manual required)

MISSING CONSTRAINTS:
  ⚠️  Blocking relationships not enforced
  ⚠️  Task size limit not validated (≤8 points)
  ⚠️  Definition of Done not automated

MISSING OBSERVABILITY:
  ⚠️  Stalled work detection
  ⚠️  Burndown charts
  ⚠️  Critical path highlighting

================================================================================
CONTROL MECHANISMS
================================================================================

1. FRONTMATTER VALIDATION
   - Templates specify default status
   - ProjectId validation required
   - All fields initialized

2. COMMAND-LEVEL CHECKS
   - Verify current status before transition
   - Block invalid transitions
   - Work log documents all changes

3. QUERY-TIME AGGREGATION
   - BasicMemory queries return current status
   - Parents calculate from children
   - Hierarchy displayed in tree

4. RELATIONSHIP CONSTRAINTS
   - Frontmatter links maintain integrity
   - Obsidian wiki-links for navigation
   - No bidirectional enforcement (gap)

5. TEMPLATE-BASED VALIDATION
   - Task: Definition of Done checklist
   - Manual enforcement via code review
   - No automated blocking (gap)

================================================================================
RECOMMENDATIONS (Priority Order)
================================================================================

PRIORITY 1: CRITICAL INFRASTRUCTURE
  1. Create references/status-flow.md  (state machine diagrams)
  2. Create references/schema.md       (frontmatter validation)
  3. Create prd_template.md            (complete artifact types)
  4. Add webhook automation            (PR merge → auto-update)

PRIORITY 2: ACTIVE CONSTRAINTS
  1. Enforce blocking relationships    (block Done if dependencies blocked)
  2. Validate task size                (reject Task > 8 story points)
  3. Validate Decision closure         (all Unresolved → Retrospective)

PRIORITY 3: MONITORING & OBSERVABILITY
  1. Stalled work detection            (alert if Task In Progress > 3 days)
  2. Burndown tracking                 (completion % per Epic)
  3. Critical path analysis            (highlight blocking tasks)

PRIORITY 4: USER EXPERIENCE
  1. Enhanced status queries            (--epic, --blocked, --overdue flags)
  2. Batch operations                   (/project:close-epic #4)
  3. Visual status dashboard            (tree, burndown, metrics)

================================================================================
CONCLUSION
================================================================================

The status workflow is WELL-STRUCTURED but INCOMPLETE:

✅ WORKING:
   - Explicit status fields in frontmatter
   - Command-driven transitions
   - Hierarchical aggregation (task → story → epic)
   - Relationship linking via frontmatter

❌ MISSING:
   - Status flow documentation (status-flow.md)
   - Schema validation (schema.md)
   - PRD template
   - Post-merge automation (webhook)

⚠️  GAPS:
   - Blocking relationships not enforced
   - Priority algorithm not documented
   - Status validation manual only
   - Blocked state not monitored

FOUNDATION: Solid architecture with clear separation of concerns
IMPLEMENTATION: 80% complete, needs final 20% to be production-ready

EFFORT TO COMPLETE: ~2-3 weeks
  - Week 1: Missing files + webhook automation
  - Week 2: Constraint enforcement
  - Week 3: Observability + user experience

================================================================================
